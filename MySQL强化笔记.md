---
title: MySQL强化笔记
date: 2024-05-26 20:08:14
tags: [MySQL, note]
---

包括MySQL基础、MySQL调优等。

<!-- more -->

# 存储引擎

## MySQL四层架构

1. 连接层

   最上层是一些**客户端和链接服务**，包含本地sock 通信和大多数基于客户端/服务端工具实现的类似于TCP/IP的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为**通过认证安全接入的客户端提供线程**。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。

2. 服务层

   第二层架构主要完成大多数的**核心服务功能**，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。

3. 引擎层

   存储引擎层， 存储引擎真正的负责了MySQL中数据的存储和提取。**数据库中的索引是在存储引擎层实现的**。

4. 存储层

   数据存储层， 主要是将数据(如: redolog、undolog、数据、索引、二进制日志、错误日志、查询日志、慢查询日志等)存储在文件系统之上，并完成与存储引擎的交互。

## 什么是存储引擎

存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。**存储引擎是基于表的**，而不是基于库的，所以存储引擎也可被称为表类型。我们可以在创建表的时候，来指定选择的存储引擎，如果没有指定将自动选择默认的存储引擎。



三种常见的存储引擎：

- InnoDB：兼顾高可靠性和高性能的通用存储引擎，在MySQL 5.5之后，是**默认的存储引擎**。
- MyISAM：MySQL早起的默认存储引擎
- Memory：表数据临时存储在内存中，由于受到硬件问题或断电问题等的影响，只能将这些表作为临时表或者缓存使用



### InnoDB

- DML操作遵循ACID模型，支持事务
- 行级锁，提高并发访问性能
- 支持外键约束，保证数据的完整性和正确性

文件：

xxx.ibd：xxx代表的是表名，innoDB引擎的每张表都会对应这样一个表空间文件，存储该表的表结构（frm-早期的 、sdi-新版的）、数据和**索引**。文件是**基于二进制的**。MySQL提供指令`ibd2sdi`，可以通过该指令从ibd文件中提取sdi信息，而sdi数据字典信息中就包含该表的表结构。

### MyISAM

- 不支持事务，不支持外键
- 支持表锁，不支持行锁
- 访问速度快

文件：

- xxx.sdi：存储表结构信息

- xxx.MYD: 存储数据

- xxx.MYI: 存储索引

### Memory

- 内存存放
- hash索引（默认）

## 存储引擎如何选择

- InnoDB: 是Mysql的默认存储引擎，支持事务、外键。如果应用**对事务的完整性有比较高的要求**，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还**包含很多的更新、删除操作**，那么InnoDB存储引擎是比较合适的选择。
- MyISAM ：如果应用是**以读操作和插入操作为主**，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常合适的。
- MEMORY：将所有数据保存在内存中，**访问速度快**，通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性。

## （待补充）InnoDB的逻辑存储结构



# 索引

索引（index）是帮助MySQL高效获取数据的数据结构(有序)。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。

## 索引结构

| 索引结构              | 描述                                                         |
| --------------------- | ------------------------------------------------------------ |
| B+树索引              | 最常见的索引类型，大部分引擎都支持B+树索引                   |
| Hash索引              | 底层数据结构是使用**哈希表**实现的，**只有精确匹配索引列的查询才有效**，不支持范围查询 |
| R-tree（空间索引）    | MyISAM的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少 |
| Full-text（全文索引） | 是一种通过建立倒排索引，快速匹配文档的方式                   |

### 索引结构为什么会选择B+树

B+树与B树相比，有以下三点区别：

- 所有数据都会出现在叶子结点
- 叶子结点形成一个单向链表
- 非叶子节点仅仅起到索引数据作用，具体的数据都是在叶子节点存放的

MySQL在原B+树的基础上，增加了一个指向相邻叶子结点的链表指针，就形成了带有顺序指针的B+树，提高区间访问的性能，便于排序。

**选择B+树的原因：**

- 更适合范围查询：若使用B树，因为数据存储在不同层的节点上，范围查询时需要跨多层回溯。而B+树所有数据都仅在叶子结点上，且叶子结点通过双向链表连接，范围查询只需要遍历链表即可。
- 更高的存储利用率：B树每个结点都要存储数据，导致单个节点可以容纳的键数量较小。而B+树仅存储键，单个节点能容纳更多键，树的高度更低，磁盘IO次数也就更少。
- 更稳定的查询性能：B+树所有数据均存储在叶节点上，每次查询必须走到叶子结点，路径长度一致，性能稳定。
- 更高效的全表扫描：B树全表扫描，需要中序遍历全部的节点，而B+树直接遍历叶子节点的链表即可，效率更高。
- 更适合磁盘预读优化：磁盘通常按页（4KB）读取数据，连续数据读取效率更高。而B+树叶子节点存储连续数据，顺序访问时磁盘预读效率更高。

### Hash

- Hash索引只能用于对等比较(=, in)，不支持范围查询(between, >, <, ...)
- 无法利用Hash索引完成排序操作
- 查询效率高，通常只需要查询一次即可

在MySQL中，支持hash索引的是Memory存储引擎。 而**InnoDB中具有自适应hash功能**，hash索引是InnoDB存储引擎根据B+Tree索引在指定条件下自动构建的（不支持用户手动构建）。

## 索引分类





